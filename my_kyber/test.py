from __future__ import annotations
import hashlib
import itertools
import numpy as np
#import sha3

n = 256
k = 2
q = 3329
eta1 = 3
eta2 = 2
du = 10
dv = 4
zeta = [17**i % q for i in range(n+1)]
n_inv = pow(n, q-2, q)

##### Test vector
# tv_d = 0x286cb5765278971b5bc8ea4baa3169124d9ab66e9e35d1badd01135d6ac9f077
# tv_G = 0x47c104096c850a9c066ea2b5cdae9c107965ae896dbd559888ff23f4712e734547435e73bd2f36d0dd4bdb1c6cd193a1c82853153561611aaaef5f491057c377
# tv_A = 0x0b01a6064f087206df028a0ad3079d056f048002e807e103060863084d06aa017f02da06e10c1807f50244010a087f07bf0c1408a600ec01b806a50108007d0574007d08f50cfe065409840bb303f600bf074604cc045d04fb0804053c095e02e20ccd0796081407bb033905b603a5013c036b06030a0408310cd008830200075f079f0bf9061e0cf206f005290afd013f0a5c0bbf0395046201a4026006a50adc04bb0cc003d20209055908050ab9049c05740b4a07640a1b0b0c05bb0bba03a300a804ae05c607a0032206450566019f03d00a140396098700050c7f0c690a26069608ab0c740abe031308e40b690bdc088b08c200260a390ac1067e0cc50c55037b06fd07a801e100410a620c0d06f00693075101d1085e006808100a63054705db0a860c660b760c820008064507ea08cd0cb70cb7081101a901bc08700cf40688075206d6021a075a0be409b909b109ca029d066105980cc80b75016e05ac08540c9607f100520989089a0c6c0a8a00bf0baf071508d207d1062d055301a90bb902e10418022f06c206fd057009ee07fa02ee033401b3006c074b0c5a00cd04df01c604b006fb083a014204000d68046003350a24034e018900c00a2b07d804de0547057e089a0a2404a800c10772024b02c602290b3d0bbe06c5073e03ff09e6000d0c6d01410b9100b3049c0c5e08a10bdd0b18042d07d3062a0c6e0ca4019b04900cd30628020005a4062e07e20af9063306a205df03e20073030005c608b90b51082105320c37078506b209910cce0ab60a6c02f9042308030b620b9205a206dc0cc700e3030702d503b7040605fb0329069101ea0a4a0117091009f10a6e025b030403f202c30ac806790313091307540af202a10ac60cea02a3044b06e80738040b0c0e04e20a4f00f40cbd099f01c40476058d04720b60049b02920c2e0a3f01b804de08ad047f02e1070f07950063000301950b670ae0036d065804350a1d09b80a630c770b660ad5013e060907cb02b0093d015a010303e001f40ad20171071b054008680b6a091d01000891063109460adf02210c060c5c0500072403ef088c04b209200656066d04fa02d007470bfd05f70b5f04ad05810ad7096306f8018808c70888080e0c690cc5033a0a5c066806be0c2701cf02cc00f307b10c45016109a206d10968089004140198030601a9039d0aba08b00c29060301ba0159029d07b40c340c120ba40aa90075096a026a0440016f08760a7d086504ae016301b30a080c75034a0bcf065f0c7704b20cba03800231053407c00403055205b9021a0bda0837023902ce02f909120a0d07bf009c0cb5093109270150044e084c03f00589099c030c00020621028b012706c604560af70cd208450ad602a2061805740a7100c1083a060b02f30375091e0b7c010d02fa072500a00647001f0ae605350bce00150cdc06e800ec0056047a02500a150a96024b0572018706b90a2c0789065c04a7008f05e407f600d9090c037c096b0c8c09b600640b64015303e905c60a8d0b1f065600f60124072b083007910a480c5409fd00c70510032b097506090afc0a19030d030c065909560b27011104830a2e0a5a07d8063000ab09370cc3048e02c800a202bb078904300007013a0532057a0210079a01d807360686020b03f4001b01dc04b80b6907960b1c0aa405a50b110a4806440acf0a19096100d30c6308bb09e90c0604600cdf00fa01990bb40a8c056c0aca00e602e409370720008000f601a20bc20c0406ea066a045a08e8047b07a508770630048d0aee09b40b3808120c50007701ce02cf056802470cf10a010ac00628035b09ff079f058b017708880b6a049c02f0006706c201a904bd045601b004d00ac70a7d06720ac403b40bbb09c1004b0465049e0ad109dd092709ea01f103f6028c0a13008106e30a89033a044205b8024c048f050002a606430c5901ff04d802cd03d0059203480366013d0c40049d05030526010001fa0791022b094f0bd70ccb0cc607d3061f06fa02510711044c076e02a60c29004a013a0c690b110cdb07da0c7907db0015002b0c34013b065f03c009750a3d0832017209870925003c08f4068003600ce40435066500cf021d093b05c2096801b605c8040e0a6900c402030a8903170b44025b02e208840cf4032109d909e9027406a80c9503d60a8200c30bbb0b5d0067079806f50cd60a480a290c0b051c0b55035807d60c450578043c05b70657051f09e10c7a0593074a02e40c390546099508e2028b0ae206da030704a60558035803a9048e06e4092c01ac011c002e014603f40cf006100779006600470b4f051e0b470180082a0b3609fc005b01c101190c7e09250b7b056905840a7f000e0bae005b009a008a0422012607cd083301a808970a2605de06930ba70818074b021c03990a3c038804c00b720bd605f507e606af029104b504460afa09cb091a01ef073f079b027e0c0c00e907c20a1a0a630bef0b410b880a0d048e097300ad00cd05630aee080f0c360c7804ef085202e502ac0c600c9f01540c540af804a207c2098f035407030092048e05bd0ad40a7609dc05d802e700ed00fd002f0a3605490543072700e4036f0aaa08c809b20957000e094609ba0c3105ba01a5070e02bf0a65062500db098f043209be08e20079050b0242022c07fd030a0330071006230846036108ec0b950bbd03280b980ced02b80850033702460641070b0111055807f604880577069802f306ef07bc023f0932062303e305d00169026a065e095401ea012d097900fe0630008e04380734077109d6086001e506aa04f7084908040a980ae307950c8702d90cf4065f0cab0cce057f0a3609e907
# tv_s = 0x01000100ffff010002000100020000000000feff00000000feff01000000010001000000000003000000fffffffffeff030001000000feff0000fffffffffeff0000010000000000010000000000ffff0200ffffffff0100010000000100ffff0000feff01000100feff02000100ffff01000000ffff02000000feff00000200ffff0100fdffffff0100ffffffff010000000000feff00000200ffff0000ffff010000000200ffffffffffffffff0100000001000100ffff010001000100010001000000fffffeff00000200000000000000fefffefffeff0000ffff00000000fffffeffffff02000000ffff01000100fdfffeff01000000ffff000001000000000001000300ffff00000000010001000000ffff0000fffffffffeff00000000fffffeff01000300feff0000ffff000002000200feff00000000ffffffff0000ffffffff0100feff000001000200feffffff0000feff0100ffff000001000100020000000000010000000100ffff0100ffff0000feff02000000ffff0100ffff000000000100feff0000ffff0000ffff010001000000fffffeff0100010000000000ffff0300feffffff0100000002000000ffff0200ffff000000000100feff01000100000000000100ffff00000100feff000000000100ffffffff0100010000000100020002000200ffffffff0000fdfffffffeff0100010001000000fefffeff010001000100feffffff01000100ffffffff00000100000000000000feffffff01000000ffff010001000200000000000300ffff0000ffff02000000010000000000000001000100feff00000100ffffffffffff0000010000000200000003000000fffffdff000000000000ffffffff010002000100010000000100feff01000000000000000000fdff00000100010000000100ffffffff0000ffff0200020001000000000000000000ffff01000100000000000000ffff01000000feff00000100ffff010002000100fffffffffeffffff000001000100000000000000010001000000020000000000010000000000feff0200000001000100feffffff0100000001000100ffff02000200feffffffffff00000100000000000200000000000300fffffeff000000000000feff000001000000020000000000feff0000fffffffffeff000000000000000002000000010000000100ffffffff0000feffffff01000100ffff0000fdffffff0200ffff000001000000feff000001000000fefffffffdffffff010000000100000002000000000002000100ffffffff0000010001000000000000000000fdff0000ffff01000200fffffeffffffffff0200ffff00000100feff00000300ffff020002000200feff02000100000002000100ffff00000100ffff0100ffff0000fdfffeff01000000fefffeff00000000feff
# tv_e = 0xfeffffff00000000ffffffff000000000000fffffffffefffffffefffeffffff00000100ffff0000fffffdfffdff000000000000ffffffff01000100fefffeff000000000100000000000000000000000000010000000000ffff00000200feff0100feff0000ffff0100020000000000020000000100fefffffffffffeffffff0300000000000000fffffeff0200ffff00000100fffffffffeffffff010000000200feffffffffffffff020000000100feff0000ffff000003000300fffffffffffffeff020000000000000002000200feff0000ffffffff01000000feff00000100000001000000020001000000feffffff0000ffffffffffff00000200020002000100000000000200010003000100000000000200feff0100ffffffffffff010001000000feff0300000001000000ffff000000000100ffff00000000feff01000100ffff000000000000ffff01000100feff0200ffff0200fffffeff01000200fefffeffffff0000000000000100fffffffffeff010001000000ffff0000fffffeff02000100fffffeff0100ffff02000100010002000300010001000000ffff000000000100000001000200fdff02000100ffff0000000001000000000000000000000001000000ffffffff0100010001000000010000000200ffff010000000100010002000100000001000000000000000100ffff0000feff0200ffff01000200fefffdff0100fffffefffeff0100ffff0000feff0000ffff01000000ffff000001000100fffffefffeff0100ffff0000ffff01000000fffffefffffffeff0000fdff000001000100ffff0000000001000000feffffff0000feffffff0000010000000200000001000000feff0000ffff020000000100ffff0100ffff0000000001000200ffff0100000000000100000000000000feffffff000000000100ffff000000000200ffff00000000000002000000020000000000ffff03000100ffff020000000000ffff000000000200010001000000feff01000000000001000100ffffffff000000000000feff000000000000ffff0100000000000100010002000100ffff00000000000002000100020000000200fffffffffffffeffffff01000000000001000000ffff01000200feff0000ffff0000ffff01000200ffffffffffff00000300020002000100fefffeff0100ffff0000fdff0000000001000000ffff0000ffff0000ffff0000ffffffffffff01000000fffffeff0000000001000200ffff0100fefffeff01000000ffff0100ffffffff0000000001000100ffff0200ffff0000feff0100ffff02000000ffffffff02000100ffffffff00000200020000000000ffffffff01000000ffff0200000001000100010001000100ffff0100ffffffff0000ffff010000000200fefffeff00000100ffff0000

tv_d = 0x2fe3d28009a2a3b054d7b5519bf16c420749a9bf97a608208ad77c4dd5d0ee74
tv_G = 0x144caf4aa2b882a1a271a40842d51536147bc64ef466d059e28c4858b94296e315be8eb5601d998a664d320d2237f6d5e3170c3861c814812f99f6a4aa73a021
tv_A = 0x2e0068011307a804e805d60167045d013f0c0900ac0b1306d509140744052105fb0b8a07d6090f01d40c5901490650051907d709530630010c0285024f0618080c090200d1099c0be8004605d0001f03a507230615004305fc07b4016b0c010cb2010e00b70bf601a90bdc07820b2202740cbc01580c3f07c005d80364080206390aee036609e30aa40a070ce5000301a9025c05b6070307be042f02b3055d03c0084c011f019a012e0a71028403b60b2d028700ed00ee06040a4902760801020e0801049b07c004840a56084203e60600035a0637017203fc042d077707a20520069704ab0c960c0d04c305ce0ad70bc3069f062e0229062d00190ada074305a107b70042022e086f01a201bc034d0302088b0bdc0c9801e004fd0a26050402f50bab09570c380bdd07140b0906e30c1d07960b9f037001850a9609ca069c01e20624091300e906600ad006fe011a0603065b083f00710bef0bdf088c0ced019507d409ff02fe0ccc07df0b99046d0c520799008900c209b601f5090f0ba6059f02a70701033902df062006f4099c05c20a6607ed043605cb086106b10003053e005d01d900e8045d008d0c9608b1000708880c3500aa003303ee06ae09ca024001180bb50b25004f06120b89082401db0c8708d600450ca3007009a402f107b3074e057600700259028206cf0c850c9e03ef00fa0ca202ef097b086d03fd0a6a09c80aab02e8007202440561087104c205af04790197003004db00bf0b11055d0034030909500cbc0a8b0b250ac000a40483018600d703360a6f00a1066d044401a40071098302d60c4a029a01e304ae0caa0793045804bd0520059606990b7500d6057805440b7e08990197096c045106a303a609e3080b04ee08760c72069404f40bd70aea0c2100f403e8058805a30a4e089f0678059009d70539094806af059f037906ce067d0ca300c603d6046c095c0ca6022c07c10ae0099f058a09f109ee0b57074409330506000908fe0bf1055e07a9061c03030adb0c3c0128008d088808c80c6505b4056a0bf8000309480c0f09860c0e03cc0b54020f0cbf0954072a082304970c15096b040e04bd03d5065e0c3600e7060405d60062005305ee080f080203d60a30009b0a2306c70c2e01e9072e0ac90353095f0afe0471092b007c015b0aea042a02e302a00b830c27027b0a200ba8002e0ade053b002b05d40cb90b1008c9035d0349011602440a620839008b01f400430a8103dd07f702b103950126043604850a7a047503690a1b00b60bd302230a010c00004c0322069107b80ace08f20b2c0626090a038d02a70cd2038308d3068f06ed072b029105cf08580bdd0673096f08bb0bf90bf0083d026a07ff08e209cf0bb501c8031608b90b1a0055022a04b509410332033d020a0a4d0480025a01ad026903b206e7049404000747074c045506f8044f09a80656073a0037091b04f805d501b00241058403fa0be20a3405910476008b01fb034e07c7092601d4005906580185076007c708c607e601290c6800b704fd067e0062054f07ae0b43069d047a0a4f075000e50ada01800cfd00d7004b09c90a450981027e08fa0095055f0bf4053d0b460a09015806f601c50c3500c2031706c80bba07270355063204f506a0052500e102bc0360052b06f705a003470145009e0cb5006802df08d50bdc03e80bd006d808a6048f063804fe013a07cf01bd085a09d709ba006d053d02bd03bc04ad0437053d08b10cf7057a087303600b0102a900f105490236054d08f2074e0bbb046f0144090e044907500afd0347092a03b100850544075f075000df04f5060d0ab209e70a47053b0bc2070204000d400199073709ac09160ca307f60995029f097f0c6102a200c808c50266069a0a70052902e200f005200ad90aad004c03cb029f0c0507b40b1a0645001e0c500b8c09340acc06660a4c089e0639085703a10c8703f200480638010a028e046c044e02fb01e70cb9025f0a6b0b800090017009e70258038208ef0848052401430c2509a7095a0ae701f40c7109b40a6209d202b901280aef092d0930083007b0053f045a0b3b039b06050a2507bd049c0bb8062806ee03c90b220918024d05eb0cad0cf604de026a0ba00069017d09f4037807c40c000d44000d0ca00aa90716090405180a3f068308260032021303d0003909bd049a095908b709f107430a7807170290099b0bd4094402820c7403570a8b0c6f026f0955089e03b709aa095c06e909490a84075407080bdc0a2b0a2500e800a40a3703560ac203cd0c6c0c460c110c6c0886047609f9014703d10093092406bd099002e100a405a102310b510486026608ea0ad80b1d0ccf0087021b0128052309e606d5079b09f40242007c034201e804c4056f0c1509fd0a46070109e6082007020574035008670a120ca7067a044004e500ac06fc02f20716040c092d00b305a600c0065402670c6501520c0f0aa108790aee0cce0a4d03ec0740082c0c4405020a0008be029c0c61069e0b970aa0032f053001ca09a6035c094d041c000b061d08ef0bd906d9026e0cff0304012902d4086806940bf1077600360a9f0cf70c670904076f04be03ba065b0227028008ef06a206c908d300a704f106ea082b0a1e0bb5026b0b75084d04c20b060444036302ef071306d30c7207a7078d014e092707470241039d09d50ac400fa00b209d40299083e0b340b430cf604260b820838015a02830c6409ed0323030106ce0b140858041e04e002e107bc0bee06850441097b07390298070400970a2b0cb007b407ed01f800aa01890bce028b043508370cbf055909e60aaf0b890a3c045004aa0a8f0c620b2a0313018c04e5085104
tv_s = 0x0000ffff0000ffff0000fefffffffeff01000000ffff000002000200feff0100ffff00000100010000000000ffff0200feff000001000000feff0000ffff00000000ffff0000feff00000000000001000200ffffffffffff0100000001000000ffff0000ffff01000000ffff0000feff010000000000000000000100ffff02000200feff010001000200000001000100fdfffffffeff0000feff0000feffffffffff01000000feff000000000000010001000100ffff00000000020001000000000001000000020000000000fffffeff0000ffff01000000020000000200ffff01000000000000000200fffffffffffffeff00000000ffff000002000100ffff0100ffff00000300ffff000000000100ffff000001000100ffff03000000020000000000ffff0300ffff01000100000000000000ffff0000000001000200ffffffff0200ffff000001000200ffff0200010000000000ffff03000100010001000100ffffffff010002000000fffffdff02000100010000000100ffff020001000100ffff00000100020001000100ffff01000200ffff01000000ffff0100000002000000ffff0000feff02000100feff01000000feffffff0000010001000000feff00000000ffff0000fdfffeffffff0000ffffffff0000ffff0100ffff0000ffff020000000100ffff01000000feff0200020000000000010000000000000003000000010001000000feff0100ffffffff00000000010001000100000000000200fffffeff0000ffff0100ffff010000000000feffffff0000fffffeffffff000001000000ffffffff01000200fdff02000000ffff000000000100ffff00000300feff0000ffff00000200ffff0000feff0000ffff00000100ffffffff0100ffff01000200ffffffff0200feff00000100ffff01000300ffff000001000000feff00000100ffffffff0100ffffffff0100ffffffff0100020000000100ffff010000000000ffffffff0200fdff000001000000feff0200feff020001000200ffff01000100000001000000fefffffffffffefffefffffffffffeff0200020001000000ffffffff00000100feff01000300020001000100feff00000000000003000000010001000000ffff0100000003000000fffffeff02000000feff00000100ffffffff0000ffff0100010001000000010000000000feff01000100ffffffff00000100000001000000ffff00000100000000000100010000000100ffffffff000000000200000002000000fffffeff0100000000000000fffffeff0100feff0000010001000200ffff0100feff0000ffff000001000100ffff01000000ffff01000200ffff02000100ffff000001000000010002000000ffff00000200fefffefffeff02000000feff0000ffff00000000010001000000000003000000
tv_e = 0x0200000001000000fefffeff030000000000feffffff00000100ffffffff000000000200fffffeffffff00000100ffffffff020001000000000001000200ffff0100fffffeffffffffff0100000000000100ffffffff0000ffff01000000ffff0200feffffff0000feff00000000fffffeff00000100000001000200ffff0200ffff0000020001000200ffff0100010001000000ffff0100fefffffffeff01000100000001000100feff0000fffffeff0100010000000100ffffffff020000000000ffff0000ffff0000ffff010000000100ffff010002000000feff02000100ffff0100ffff0000ffff0000ffffffff0000ffffffff000000000100ffff000000000200000002000000feff010002000100fefffeff010001000100feff00000000ffff0100ffffffff010001000000fffffeffffff010001000200ffffffff000000000000020000000000feff0100010001000100feff01000000fffffeff0000fefffeffffffffff000001000000000000000000ffff0100000000000000feff010000000000000000000000fffffeff010000000100ffff0000030001000000fffffdffffffffff0000feff000000000100000001000200ffff0000020001000000fffffeff0100ffff00000100010001000200ffff01000000020000000000ffff0000000000000100fffffffffeff02000000ffff02000000010001000100feff00000000fffffffffeff0100fffffffffdffffff03000000feffffff0100ffff0200fffffffffdff0200ffff0000ffff02000100feffffff000001000000feffffff00000200000000000000ffff02000100ffffffff00000100ffffffff00000000ffffffffffffffff0000feff0100feff0200ffffffff0000000000000200feffffff000000000000ffffffff0000ffffffff0100ffff0200feff0100feff0000000001000100010002000100000000000000feff0100feff000001000100ffff01000100ffff0100ffff0100000002000100010002000000fdff010000000100fffffdff0000ffffffff00000000feff010000000000feff0100ffff0200ffffffff00000000feff0200ffff00000100010001000000feffffff0100ffff0000ffff00000000ffffffff0100ffff000000000300ffff0200feff0200feffffff03000000feffffff00000000feff00000100ffffffffffff00000000fefffeff010002000000fdff0300010001000100ffffffff01000000fffffdffffff0200ffff01000000ffff0100fffffdffffff020000000100feff0000feff000001000100ffff00000000ffff0100000000000100feff00000100fefffffffeff02000100ffff02000000ffffffff0000feffffffffff020001000000feff000000000000ffff01000100000001000100000001000000feff01000000
tv_s_ = 0x0b06f0057c013b060d06bcfa43059105eafd9dfd91f92efad8fed7f9c50344ffdbff230304fbcffecb01f6f97802f004d4040602c9fc3a00b902aafd35060efc52056e0603004203de05d800b904740453fe39fc7304560650fe9dfe48032d0018fd92015302ab04ceffb4f92c027ffd1cfb00fa3000720360015ffceafb3e00020249fefaf9f4fe5e012d04acfa7905130181fe7aff8ef97e00b2fa270287fdec0351fd6903eb03f6036d0067fa17046304a300ee016fff51010b009af94800e0018c0449fe17fd5efc19ffc9fa790210fe830274026afc5bfe13009505a7ffcffffa02dcfd130379ff5c023a05a60316fcc90196038c0047fb19fb05fdf7fe2d036906ddfe890257059b03ec0174fc1d03e202d50370033afbb40404053e01a3055305f402e4fd9504e9fc6ffd1600b403faf9befebe051c06d7fdcbff29feedfe77fae5ff3801fd0441062c060a01fafebc001afbf602feff7000acfccbfc9bfa95ff77ff05014afab2fe56fb4c05b9fbc1fac0fd7c0501013d0404045e03db02ed038f00d3007dfc39fe8f017bfe550461030703ae036e056fff99ffe601cffc37fe3d05e5fd1200be0426fcd40210ffc0f944ff7afc6702ae0040022d02e1f9d8fde2f9b400b9fefb05d3ff6c009efd9d0268018b036303dffd16ff910466fa66fe9bff3401b9006e00f0ffe4f98af992fe64fd60056e0266009c00ef026a0174fd74ff3bff8bfc02fb40036aff8f03b705a7ff7cfab8f9e4015eff2ffb410273fd2afa6dfe360498fbee014cfc9bfeeffc9d0461036dfba3fa4304cc0478fbe2ff2005e101a3035206a80009031afa2c01cafe6304bbfe4104da02f8fd3904b300140521022505200397f9ec01070303025efab20242fe78fa90fd90fbd7013cfd97f975faba04030090f9bafc76fd65ff6afc0c01a2feb205edfc8afd4006e2006d03c7014801a303f0fe0400e00554fcdafee904f2fa5fff9d02bcf95f0596fe9d0383fbb9f91cfa2605adfc84fe9304cd0212018eff85fd09008005700416fa7ffbe1042a030bfa2cfd3c062306d3febc05ab05fefdc2f99effcb05aafea4fcb4fde9fb8b05b1fab1fef1fd3a01df00cbfbfefded02e601460679fe9100fffd79fb5c032b030c030b065802f3fb2f05d4fe3501960359019afe79010d027302790126002801ae024afb66fb70fd4304cd02a2024bff20fdb9024306c3fce8055b0396fa3505f8018d002a0087fed3fd70fb90fa400180fe91002903ac03a5fa06ff7b00f205170509055102eafed704ae049cfeedff19fd77fd2506670415fea5f92bfa8ffd43004404eb00c4fb5cfc7105af0548fc4effa90508fa1701ea0460018e0421fd4a061e018d02d2ffaa03090405067306b00508051102b5fd57010cfb7100bdfa8002d7fd5f031afd49fcec05ba03170577008efc1b02
tv_e_ = 0xd901b90284f935001cfcad0171fd2f03f5ff92fb5c032bfd5c05ebfaba00820433fd47fb4702490140fd7b05affb72fd18fd9d003efce3ff7502caff75fd3afbb6fcc9fef6fddefeea00a5fcf2fa9402940344fbc3fc730155006d017bfcf80579fc8503f9fe0efb600035ff8a00c100ecfb81ffcafcd9ff1c066504fef9e6ff9bfbbe052704f3fe7dfac9fac2fc64ff2706f9056c002f05c201e2fee102d2fe70ff270568021504bcfe6fffa7050a012ffcf3fa5bfe95feabfd70fa9101c8051e054bfc2e0248041c014c04e3fcf1feaffe97f9edfd49ff4b0498fe99fa8a03d70098f97e039aff4d057ffb50fbab01f6020703fd02d9fb0a060c02b7f9d5f9f204dff977fd38fb52fce4055b00830309fe33051eff75fbaa054902a1f95efce9fd380636fc580035fd2204350521020ffd2f006906b801dafe45fdb9ffe5fa0a03b90532057efb480287017afecc02b203ed031c06cc0021fe2f01ed0160fa440124fdcdfcb4f9eb03cc03bf00010073fe8903ffffc304bffdbf0190fe17053700550529040cfcb10477fb1704bffd4c06d9fcedff2c0194ff16003ffa93029405ecf9a4fe0efcd7056a00d1f9d302e90374fdd6fd32050300250142ff1d06e4fb1afcfa05c9011806ceffc1fd12005e00760336fb3c05bb023201a7fb1701c80157fc9cfaa900abfa27fcb20021013a00e705f1fff10438fa3c0326fffdfc0a05b1fceefa9ffcaa00a7feb6fe8901ccfd81fe9c022cfe1701490411fcec0204062f0208057cfb5affc8fd04fa3afffd0025fd2b032cfed8ff10067bff14fba2fc01fb45054a0283fe8ffc38010e02f9fde6fdb805a003eb01e2fedefd9f005bfa45fb1d061700a3f9b505e100e20526fc05fe07068b0366030a0298fcacf9270372fb7903abfb66faf4ff33fd8105dffac6ff1e03defe3104b10575fcd5fda8fa090140fbb6fa8bfafb0300ff55fbcdfa8a05950006051cff81011106900251fab7ff83fac8fbadff75fb460217fc61013b02b10117faa604b4fc0e026ffecdfe9101e7fa3efbedfcd5016c063c030bfc4afb00fa3502190606007402bf03a902190239fc82f9c2f94f012700d60025fbebf99afcbcfd7f06caff69fc88042c00350403fd92f903fe0cfcf2fd0f011afae000c404ee02340175056bfcdcfec402ca0544fc9805b6fca2fa00022d04d304dafd0400e2fb08fb3efd82fea8000a06d5029404a70546fc95fe3702340060ff4e05a0fa31fff1fd54fdba0296fae9f9a905b2fde4fe4e0563fe1d057aff13fd40fa3a06b8fa34fdb5fee600e9002d004904fcfd84fe75feeafa5d0354fc85fe7f004ffe46019f0275012ffeef03d2fb38027d0645fe78fec2fa24fc08ff68fb9bfee7feb4056902ccfc54fa75fbb2fc35ffc4ffe3ff540070ff2f029afe19fe8efa24fa1a0421fa2a030b0007fc
tv_As = 0xde036005d20590faa0ffeefc9200ed01ef04bd00ecffa704e3fc02fb75002cfbe8fe1003910328fe5f03e902e204ce00e0038f0452fccefa18fdeefcedff4504cafa76fe560594fe1302cd0195040103eefe9afb4f0675fa3c00dbfe08fefb0057032cfcfafdedfb2e01d0fa6202ddfcb5fa8bffebfc40064104e1fc3104bdfe72ffbffe38fdf8fd01fef3034ffb94fb0dfe3b01bbfa9afcd5fab3fe28feb4016d025802c8fcf504b8fbf9fd8d0021fa10fd97026afc3afd1803bcfeb2f9c8fdf3ffd30566fb300684fdcf02e8fd05006afb99fd160234050102f704450095fb71019c04ce01a2fad2fe4d0648faa305310010fa35fb5ffad4ff05fa1afc2b00e3fbb400fbfddc037d00a304ea0394064c0630fc1805df059102e2041cfc7dff14fed1fb75fa2dff510068fb03fc3e049aff64fc51fc0c047ffb0b01e8028604aefa6afc79fa1102c3fca60211fa99fb17fcc505e8fca8fdc0f9c8fa33fd2901bf018a0108018eff37017c02e8fc39fae5fdcc0162043dfd860098fc3205c0fdc9fddbfe06ff11064efafc012300eefec5ff170384fefafebc0032ff6dfc4cfeb7034d01bbfdec048b051305b4fd69fc21fd18fd4ffc9f05d302d1f96cfe9ffb84ff5cfb6e00acfd9c005b0655fa5cfc63fe8afaa3f95e0198ff8f05f6fe79029dfcb2fe7effcf0258fab001dd0374ff00fb4efe8afed5fd9af99cfc6000c4fb2efd1506a0fbdb0282fde403ddff6606f6fa47005ffa7a0022fb5c054606e8f9e9016a034a06befccefc1e05a6ff820436ffb7fea9fcb70453fa8505f6f94dfddd003c024ffaaef99201d90069026405c400ce005a02b2006afbe5fe04fe6cfa6306370487fb4601d805d9047cfad905b10206fb2704240149fecbf992034306c6038c018dfb8b0121fbf00454030a0523fdf4ff13fa9afed6fdb0fac2037102d6003303c6fca60578fe540446010c01cefa11ff6b067200bc026afd710407fce202acfe1f01c0f9bd0203069bfd7e0176fa7c05aafe660021fb9c04befb750059fa4001c60382fc1202f9ff66fe5aff1b047c0455012004c5f9c9fa31ffe4fe54fc7c06490151fe2600e80498fdc8fb95fc8301bd02d50389fab4fcfbfa920100fc57047efa49fcba044bfbc2fd4801ce054805f6fe910043fb2400c3fe6ffa6f05baffb0fefb0495fcff0365035805350539031bfac6fe7900f60429009dfa0606a9052900f903df0391fe25000d010e029a02ef05fffa4506dbf90f02d902b6001cfc74fa170252fbfffe8000260509024201a8ff3301a8fbcbfab9fab5fbac01c2fc9300edfe930409ffcd03a40052054a022afdb8fb7701b000c802d9059d0382fafb0068fe0efb74fa9202090177ff36021f0619fbb90402017705b8feb1fdf70333028efab104ae04fa03c1ff57019500e20342fbb20236ffcd05f904
tv_t_nonred = 0xb705190856ffc5fabcfb9bfe03fe1c05e4044ffc4803d2013f02edf52f01aeff1bfc57fed80571ff9f006408910040fef8002c0590f8b1fa8dffb8fc62fd7fff80f73ffd4c0372fdfd0272fe87ff95058202def61203e8fb9100480083faf306d0ffb1fff3fcfbf68e0105faec029efda1f60cffb5f919065d0a46012ffea3fe0dfb7d045f01ebfc7ef8bcfe11f8f8fa3404340727fbc90197fc95fd09018600dd017f0730ff0a0974fa68fd34062bfb3ff98afdc5facffbc3002cf943fb900311051e0294fd780aa0fe1b07cbfaf6fe19fa30f703007d044c068f03defa1fff480234fe4c053cfa1f04cc0198f54e07270317fd32fe38f6de0511fcd1f500fad50093fa72fb14ffcffc870a4504170a55046301360454013b082b07bdf5dbfbfdfb0902abf685ff86fd8aff38015f06a9fc93fcba02c40559fa50fea1026bffb8fd2302abff8ffd0bff2d048bf865fec9ffb209040374fee1f7f7fb20ff89fb0303aefed5fd42f922054806a7fd3afa58fc55056104000245fe57fec203d70200fe30042f031d02fffe73fd3a04adfc1106f0ff71fe2600500048ffacf6df004b0939fb5ffcfa00620b7d0585f73cff0a018cfa25fad10ad602f6faaefdbc0168fb76f7680675ffb406290616f86efcc1fe00fed9f49a065302c1069dfa900365fe09fb1afa780303f5d7fd8f0495003afb35047bfec602d2f3d8ff86ffc1f83802c6028ef67aff2cfe8b0293feef07c2f8c8fefbfca6fe39fca5095702d4fced079905520b3af828fce602aaf9bc033300dcfbd4ffe3022bfa950b71f961f87ffd3dfd94fff8fb150068fda1037207bdfeb4fe1208520455fdc7fde2fb0bfbbe007cffa4015d017bff8e0a5dfbbb0bd7fe0bf92e0aaf04af01d5fb2a00efffed06fefc06ff36fd87f5e40487008b0a02f8baff31fd78fd07026100370046007efb3c0406f85c0003f94f08460061fc9bf59b0400077805d801ebfe820a97fe33fd63fea2fb88f56a027801e1ff95fdd7fbb7075b007dfac7ff5001ccfde4fe26f9d102adfec0f7fffece01d20496022600c6ff55fb5506deffcffaa501a302fdfe950882fdd3f7e8f93706bffd9efcbaf76efb57ff910108017efc64f71a062cfc8c0881f7dbf5bd0257f7b4fb5702e8ff2806ba037f0377fc99052efb4bf933088405f4fa930a4bf9a1fe65058509080a13011ffaa8fa81fb3402abfe45fb100c7e08bd04a009250026fd5c0241016e01e8078f0030fa36042ff7c9046ffd9ffac50126f8fb00a00062fd9d05a0041cff82fbe205ebfbdcf880f99ffb9efcd9010b018ffe71fd0803f3f92a07f8fcd703c90279fbfefc16042502f700c8096fffbafc7807adfc86f936f5b6fe1100dffad1000605cd002207cefdcbff2dfa63fa2c03f70171fa05051e0429065bfe70ff23fb06fe5cffd3fc6002d8050001
tv_t_red =    0xb70518fb56ffc5fabcfb9bfe03fe1c05e4044ffc4803d2013f02ee022f01aeff1bfc57fed80571ff9f0063fb910040fef8002c059105b1fa8dffb8fc62fd7fff81043ffd4c0372fdfd0272fe87ff95058202df031203e8fb9100480083faf2f9d0ffb1fff3fcfc038e0105faec029efda2030cffb5f919065cfd46012ffea3fe0dfb7d045f01ebfc7f05bcfe1205f8fa340433fa27fbc90197fc95fd09018600dd017efa30ff09fc74fa68fd34062bfb40068afdc5facffbc3002d0643fb900311051e0294fd77fda0fe1afacbfaf6fe19fa310403007d044c068f03defa1fff480234fe4c053cfa1f04cc0199024dfa270317fd32fe3903de0511fcd20200fad50093fa72fb14ffcffc86fd450416fd55046301360454013afb2afabe02dbfbfdfb0902ac0385ff86fd8aff38015f06a9fc93fcba02c40559fa50fea1026bffb8fd2302abff8ffd0bff2d048c0565fec9ffb1fc040374fee204f7fb20ff89fb0303aefed5fd430622054806a7fd3afa58fc55056104000245fe57fec203d70200fe30042f031d02fffe73fd3a04adfc1106f0ff71fe2600500048ffad03df004afc39fb5ffcfa0061fe7d0586043cff0a018cfa25fad0fdd602f6faaefdbc0168fb7704680675ffb3f9290617056efcc1fe00feda0199f95302c0f99dfa900365fe09fb1afa78030402d7fd8f0495003afb35047bfec602d300d8ff86ffc2053802c6028f037aff2cfe8b0293feeefac305c8fefbfca6fe39fca4fc5702d4fcecfa990551fe3b0528fce602aaf9bc033300dcfbd4ffe3022bfa94fe720662057ffd3dfd94fff8fb150068fda10371fabdfeb4fe11fb520455fdc7fde2fb0bfbbe007cffa4015d017bff8dfd5dfbbafed7fe0c062dfdaf04af01d5fb2a00efffecf9fefc06ff36fd8802e40487008afd0305baff31fd78fd07026100370046007efb3c0407055c0004064efb460061fc9c029b04fff97805d801ebfe81fd97fe33fd63fea2fb89026a027801e1ff95fdd7fbb6fa5b007dfac7ff5001ccfde4fe2706d102adfec104fffece01d20496022600c6ff55fb5506deffcffaa501a302fdfe94fb82fdd404e8f93706bffd9efcbb046efb57ff910108017efc65041a062cfc8bfb8204dc02bd025804b4fb5702e8ff2806ba037f0377fc99052efb4c0632fb8405f4fa92fd4c06a1fe650584fc07fd13011ffaa8fa81fb3402abfe45fb0fff7dfbbd049ffc250026fd5c0241016e01e7fa8f0030fa36043004c9046ffd9ffac5012705fb00a00062fd9d05a0041cff82fbe205ebfbdd0580f99ffb9efcd9010b018ffe71fd0803f3f929faf8fcd703c90279fbfefc16042502f700c7fc6fffbafc77faadfc86f93702b6fe1100dffad1000605cd0021facefdcbff2dfa63fa2c03f70171fa05051e0429065bfe70ff23fb06fe5cffd3fc6002d8050001
tv_sk = 0x0b065f7cb1630dd67b431559ebeaa992f672d98b6dc553c4dc3c320508bdcb716f78024fd46420caa903b9b2aa35f69052e566032034de850db9444754ab9373646551ebb948d302192a1953b24acf5c6b2c02a81d1870302037600196ebe80302a2b4fb56bf5ed142ad97571321b87bfc687e307b2782a8ec23a569b33ef6d30668774163340aee01c751b1009b8604e0c1484a8ba15fa9c1ca9727113b2874b2965c3b019585cad0ac2fdd3a317acc253a653a17991c96c30848a881068abf2d9366de9b2857b539ec51971d232ed503373b484b04e513a33555f452ae95a49e706a01b4b36fbfeb5b1c86adccacb2ee8b77e68c13fd14642ca610fbcb0b1b682fff0c07adc99c9c67c9785c104b37bb57c854ba287cc1ca5701d14304e435dbd23e8f300d7ea9b38fc1b755143607e33a6e05c79a6c1ed089b33d65ae12e04b27492d111c6c45bc9767e20a40d222e296ade3460bbabb5fd4cc069fda2968b1386303ae171c496777b69c4c13b9e006f15c6e8b36b9650a566e62069cf02e6a51a775ccc38c398040b3c68f735ba8dc77b9461e5f0c834142a72be7b6369489eed1949c0b9f9d14366e487a43c44c7938ce20151ea32365a890301bc712cb3b46bc1b44da92af39340b14152225053298c61e0733205f272b439b77911a89d7d1a3986677ba340091b69b776ac66bc910a32b5beeb9a840260e6d731c48313af14b00e05595db9b4ef307c69dd26b5f75b99d4388bad67126e59a853b49cd22118f6ca809005870747180184e2ac3702dca632346bdbcb55aff3a6c9fbc5cab5b9ab5aa8e8b257bb22baf3af10dccf8afed621e46a6b79100b07ac8352bc3300b8625f4f852d55b139693159b9b170d322779610228e12a4b7886713a44cd222a4c1ca2b93264c4895e5b737935851f8da002884bad7118794011b8919032ac637a07bc07f27551091525eb7b4daed4b9eeaca1785a626764b1a6c672903a0444b40ec5d89571f55a49f9c4a9957017a14e60e14822aa641ed128d3ac3a09546073065b081521b67a150d1807be0728d8fa351baa94eca53b1775078fb921
tv_pk = 0xb79581576c7cbdc8b904cb51e4049548231d3fe22e2ff1ca1c89b5d825c79f40869110b4f8c05291257b8e9c9b630ac88104a44c33a7fd32b7885c5982f23d12938e91800484376fd12ccbf4c93f8e6170ecf2a9a2d3c0b696615d6a14304bba0ed8475fc19e7fd5bb12957f34447328981c9869a9096108ddf17731ac907597a634c68240b6a8c6078dc3d06244083911e521958aa7a1bb71cc77bf1a174303d0474cf638df07c24852b34cd5731fc41c99e2742783a1339b33de2591d21270d540797358c1d079a84574a15534163644153bb872bec28dfe9820ac63c887bac838f165aa4999ba425c5a17b5a1c2c6b93a22ac0ca90cdc428c65b6ca2c9b0453b7e2848f21ac8803f3bad63a64228564a8ba73595955610420468bb5c2732d010b432fd321004ca73ae49a1116cf726b025090c4adf30d4ba98360a90f62db5786d4c30ad1782617add6727fafca1b6978476866c7b4966217f596c21bb0daa16953126c9e073966ab801b87370482ad8f54093b58437c6b2cd390cd872c5c38622c8fb3c72dbb2894fb7ec395bcfc79ba3a599a57529ded975952bb5329692eabc63b33d08dd53c2e2c57b972265680eaa3959c8f1590a6a12377be5bbb122845568aace3c880bed0c7a4d1157ceca85eb8bbd8cb602efa4aaf618d2a00cfedf69f077ca388424e87b0a803b5cb329aa70712063760047fc84307c50504f6844620969cb249008757d8c1be828ab9344ab6a398286a8217e26ca9d8787b5be077c80c15cd5abe27162dae1b4c00ec1cd264292670cc565865df0c7da5312afe5b89834a4de97663c0fa99bbf486581c1908f19765a4612dc98882c42dbd8245b57825e98c62baf3377899592fc864334858f537a94c26ba655598083a1120977a824823ac6b8410ec87bd049a2570a25c12146e817e8f1073360443c904a7a0571c27b50fa030a69d054a1d3c88e2c58edd1568a0f899d9b110902ba708436f2a979fd7932c7af89f165422f7809c70bc9b78e79a877623b71b01e0170d06d50c22f7acccec7264c732f7217705e54129c6b5714c8207dbc5d40926d80510144caf4aa2b882a1a271a40842d51536147bc64ef466d059e28c4858b94296e3

tv_rho = tv_G >> 256
tv_sigma = tv_G & ((2**256)-1)

class Rq:
    """
    Name:        Rq
    """

    def __init__(self):
        self.coeff = [0 for x in range(n)]

    def __repr__(self):
        return str(list(map(hex, self.coeff)))

    def __getitem__(self, index):
        return self.coeff[index]

    @classmethod
    def ntt(cls, poly_in, inv: int = 0):
        poly_out = cls()
        for i in range(n):
            val = 0
            for j in range(n):
                if inv:
                    val += (zeta[n - (j*i%n)] * poly_in[j]) % q
                else:
                    val += (zeta[j*i%n] * poly_in[j]) % q
            
            bit_reverse = i# int(f'{i:08b}'[::-1], 2)
            #val = val * 169 % q
            if inv: 
                poly_out.coeff[bit_reverse] = (val * n_inv) % q
            else:
                poly_out.coeff[bit_reverse] = val % q
        

        return poly_out

    @classmethod
    def sample_uniform(cls, rho, j, i) -> Rq:
        poly = cls()
        s = hashlib.shake_128()
        s.update(bytes.fromhex(hex(rho*256*256 + j * 256 + i)[2:]))
        xof_out = bytes.fromhex(s.hexdigest(672))

        sample_cnt = 0
        for i in range(0, 672, 3):
            val = xof_out[i:i+3]
            d1 = val[0] + 256 * (val[1] & 0xf)
            d2 = (val[1] >> 4) + 16 * val[2]
            if(d1 < q and sample_cnt < n):
                poly.coeff[sample_cnt] = d1
                sample_cnt += 1
            if(d2 < q and sample_cnt < n):
                poly.coeff[sample_cnt] = d2
                sample_cnt += 1
        
        return poly

    @classmethod
    def sample_cbd(cls, sigma, nonce, eta):
        poly = cls()
        s = hashlib.shake_256()
        s.update(bytes.fromhex(hex(sigma*256 + nonce)[2:]))
        prf_out = bytes.fromhex(s.hexdigest(192))

        for i in range(64):
            t = int.from_bytes(prf_out[i*3:i*3+3], 'little')
            d = t & 0x00249249;
            d += (t>>1) & 0x00249249
            d += (t>>2) & 0x00249249

            for j in range(4):
                a = (d >> (6*j)) & 0x07
                b = (d >> (6*j + 3)) & 0x07
                poly.coeff[4*i + j] = a - b
                if poly.coeff[4*i + j] < 0:
                    poly.coeff[4*i + j] += 0#0x10000

        return poly


class MyKyber:
    """
    Name:        MyKyber
    """

    def __init__(self):
        pass

    def genA(self, rho) -> list[Rq][Rq]:
        A = []
        for i in range(k):
            list_temp = []
            for j in range(k):
                list_temp.append(Rq.sample_uniform(rho, j, i))
            A.append(list_temp)
        return A

    def unpack(self, arr) -> int:
        val = 0
        for poly in np.array(arr).flatten():
            for elem in poly:
                val <<= 16
                # Little endian
                val += elem >> 8
                val += (elem & 0xff) << 8
        return val

    def keygen(self, d):
        s = hashlib.sha3_512()
        s.update(bytes.fromhex(hex(d)[2:]))
        Gout = f'{s.hexdigest():0128}'

        rho = int(Gout[:64], 16)
        sigma = int(Gout[64:], 16)
        assert rho == tv_rho, f'{rho} != {tv_rho}'
        assert sigma == tv_sigma, f'{sigma} != {tv_sigma}'

        A = self.genA(rho)
        assert self.unpack(A) == tv_A, f'{A} != {tv_A:x}'

        s = []
        s.append(Rq.sample_cbd(sigma, 0, 3))
        s.append(Rq.sample_cbd(sigma, 1, 3))
        assert self.unpack(s) == tv_s, f'{s} != {tv_s:x}'

        e = []
        e.append(Rq.sample_cbd(sigma, 2, 3))
        e.append(Rq.sample_cbd(sigma, 3, 3))
        assert self.unpack(e) == tv_e, f'{e} != {tv_e:x}'

        # ほんとはモンゴメリリダクションとかしないと？
        ntt_s = Rq.ntt(A[0][0])
        print(A[0][0])
        print(ntt_s)
        print(Rq.ntt(ntt_s, 1))




        #return pk, sk

aaa = MyKyber()
#aaa.keygen(0x934d60b35624d740b30a7f227af2ae7c678e4e04e13c5f509eade2b79aea77e2)
aaa.keygen(tv_d)
